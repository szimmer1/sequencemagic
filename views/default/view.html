{{extend 'layout.html'}}

{{if found_sequence:}}
    <h1>{{=desc_name}} <small>by {{=desc_author}} on {{if date_created is not None:}}{{=date_created.strftime("%m/%d/%y")}}{{pass}}</small></h1>

    {{if authorized:}}

        <div class="row">
            <div class="col-md-9 col-xs-12 left-panel">

                <div class="row">
                    <div class="col-md-12 col-xs-12 plasmid-wrapper">
                        <!-- plasmid building goes here -->
                        <plasmid id="p1"
                                 sequencelength="{{=seq_length}}"
                                 plasmidheight="500" plasmidwidth="500">
                            <plasmidtrack id="t1" width="5" radius="150">
                                <tracklabel id="seq-name"
                                            text="{{=plasmid_name}}"></tracklabel>
                                <trackscale class="scale-major" interval="50" showlabels="1" labelclass="scale"></trackscale>
                                {{if annotation_list is not None:}}
                                {{counter=0}}
                                {{for userid, annotations in annotation_list.iteritems():}}
                                    <!-- set user-specific classes -->
                                    {{for annotation in annotations:}}
                                        {{for position in annotation.annotation_location:}}
                                        <trackmarker class="marker marker-{{=counter}}" wadjust="10" start="{{=position}}" end="{{=(position + annotation.annotation_length)}}">
                                            <markerlabel class="mlabel" text="{{=abbreviation(annotation.annotation_name)}}" vadjust="50" type="path"></markerlabel>
                                        </trackmarker>
                                        {{pass}}
                                    {{pass}}
                                    {{counter+=1}}
                                {{pass}}
                                {{pass}}
                            </plasmidtrack>
                        </plasmid>
                    </div>

                    <div class="col-md-12 col-xs-12 add-annotation-wrapper">
                        <button class="btn btn-primary add-annotation">
                            <i class="fa fa-plus"></i> Add an annotation
                        </button>
                        <div class="annotation-form-wrapper" style="display: none;">
                            {{=annotation_form}}
                        </div>
                    </div>

                    <div class="col-md-12 col-xs-12">
                        <div class="row">
                            <div class="col-md-2 col-xs-2 user-nav">
                                <ul class="nav nav-tabs nav-stacked">
                                    {{for index, user in enumerate(list_of_subscriptors):}}
                                        <li class="btn btn-user btn-{{=index}}{{if user.id == selected_user_id:}} active-button{{pass}}">
                                            <a href="{{=URL('default', 'view', args=[desc_id], vars=dict(user_id=user.id))}}">{{=abbreviation(user.first_name + " " + user.last_name)}}</a>
                                        </li>
                                    {{pass}}
                                </ul>
                            </div>
                            <div class="col-md-10 col-xs-10 annotations-view">
                                {{if user_chosen:}}
                                    <div class="annotations-wrap">
                                            <table class="table table-hover">
                                                <thead></thead>
                                                <tbody>
                                                    {{if annotation_list.has_key(selected_user_id):}}
													{{for annotation in annotation_list[selected_user_id]:}}
                                                    <tr>
                                                        <td>{{=annotation.annotation_name}}<br>{{=annotation.date_created}}</td>
                                                        <td>
                                                            <a class="btn btn-primary" href="#">
                                                                    Edit <i class="fa fa-wrench"></i>
                                                            </a>
                                                        </td>
                                                        <td>
                                                            <a class="btn btn-danger" onclick="return confirm('Are you sure?')" href="{{=URL('default', 'delete', vars=dict(annotation_id=annotation.id))}}">
                                                                    <i class="fa fa-trash"></i>
                                                            </a>
                                                        </td>
                                                    </tr>
                                                    {{pass}}
                                                    {{else:}}
                                                    <h3>This person hasn't added any annotations yet</h3>
                                                    {{pass}}
                                                </tbody>
                                            </table>
                                    </div>
                                {{else:}}
                                    <h3>Choose a user</h3>
                                    <p>Annotations list goes here. A possibility is to create a tab for each user and show the annotations that user has added, like so</p>
                                    <p>Annotations can be color coded to the user</p>
                                    <p>Any user subscribed to the plasmid can add annotations</p>
                                {{pass}}
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="col-md-3 col-xs-12">
				<h4> Update History </h4>
				{{for annotation in annotation_history:}}
				<li>
				{{=annotation.annotation_name}}<br>{{=annotation.date_created}}<br>{{=annotation.creating_user_id}}
				</li>
				<!--
					need button: 'make active' are you sure?
				    need button: 'revert'
				--->	
				{{pass}}
            </div>

        <!-- Custom plasmid styles -->
        <style>
            #p1 {
            }
            #t1 {
                stroke: 1px solid lightgrey;
                fill: lightgrey;
            }
            #seq-name {
                font-size: 25px;
            }
            .scale-major {
                stroke: #000;
            }
            .scale {
                fill: #888888;
            }
            svg {
                width: 500px;
                display: inline-block;
                text-align: center;
            }
        </style>

        <!-- Bootstrap angular -->
        <script>

            angular.module('sequencemagic', ['angularplasmid', 'angularplasmid.services'])
                        .config(function ($interpolateProvider) {
                            $interpolateProvider.startSymbol('{[');
                            $interpolateProvider.endSymbol(']}')
                        });

            angular.element(document).ready(function() {
                angular.bootstrap(document, ['sequencemagic']);
            });

        </script>

        <!-- jquery stuff -->
        <script>
            $(document).ready(function() {
                // adjusts annotations view height to fit with users tab
                $(".annotations-view").height(function() {
                    self = $(this);
                    if (self.height() < $(".user-nav").height()) {
                        return $(".user-nav").height()
                    }
                    else {
                        return self.height
                    }
                });

                // sets the annotations view border color
                var color = $(".active-button").css("background-color");
                $(".annotations-view").css({
                    'border-left': '15px solid '+color,
                    'border-top': '15px solid '+color,
                    'border-top-left-radius': '10px'
                })

                // make upload drop down
                $("button.add-annotation").click(function() {
                    $(".annotation-form-wrapper").toggle({
                        duration: 1000
                    })
                })
            })
        </script>

    {{pass}}
{{else:}}
        {{=seq}}
{{pass}}
